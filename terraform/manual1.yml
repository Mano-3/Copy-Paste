name: 'Manual Approval with Comments'
inputs:
  token:
    description: 'GitHub Token'
    required: true
  assignees:
    description: 'Usernames of assignees'
    required: true
  issue_title:
    description: 'Title of the issue'
    default: 'Manual Approval Required'
  issue_body:
    description: 'Body of the issue'
    default: 'Please review and comment either "approve" or "deny".'
runs:
  using: 'composite'
  steps:
    - name: Create approval issue
      run: |
        ISSUE_NUMBER=$(curl -X POST \
          -H "Authorization: token ${{ inputs.token }}" \
          -H "Accept: application/vnd.github.v3+json" \
          https://api.github.com/repos/${{ github.repository }}/issues \
          -d '{
            "title": "${{ inputs.issue_title }}",
            "body": "${{ inputs.issue_body }}",
            "assignees": [${{ inputs.assignees }}]
          }' | jq -r '.number')
        echo "Issue Number: $ISSUE_NUMBER"

    - name: Wait for Approval or Denial via Comments
      shell: bash
      run: |
        while true; do
          # Fetch issue comments
          COMMENTS=$(curl -X GET \
            -H "Authorization: token ${{ inputs.token }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/issues/$ISSUE_NUMBER/comments)

          # Ensure COMMENTS is a valid JSON array and not an empty response
          if echo "$COMMENTS" | jq -e '.' > /dev/null; then
            COMMENT_BODY=$(echo "$COMMENTS" | jq -r '.[].body' || echo "")

            # Check for "approve" or "deny" in comments
            if [[ "$COMMENT_BODY" =~ "approve" ]]; then
              echo "Issue approved, proceeding with the workflow."
              break
            elif [[ "$COMMENT_BODY" =~ "deny" ]]; then
              echo "Issue denied, stopping the workflow."
              exit 1
            fi
          else
            echo "No valid comments yet, waiting..."
          fi

          sleep 60
        done